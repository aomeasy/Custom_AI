from flask import Blueprint, render_template, request, jsonify
from flask_login import login_required, current_user
from app.services.ai_service import AIService
from app.services.rag_engine import RAGEngine

chat_bp = Blueprint('chat', __name__)

@chat_bp.route('/')
@login_required
def chat_page():
    return render_template('chat.html')

@chat_bp.route('/send', methods=['POST'])
@login_required
def send_message():
    try:
        data = request.get_json()
        message = data.get('message', '').strip()
        
        if not message:
            return jsonify({'error': 'р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б'}), 400
        
        # Initialize services
        rag_engine = RAGEngine()
        ai_service = AIService()
        
        # Get context from RAG
        context = rag_engine.get_context_for_query(message)
        
        # Generate AI response
        response = ai_service.generate_response(message, context)
        
        return jsonify({
            'success': True,
            'response': response,
            'context_found': bool(context and context != "р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ")
        })
        
    except Exception as e:
        print(f"Chat error: {e}")
        return jsonify({'error': 'р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е'}), 500

@chat_bp.route('/admin-help', methods=['POST'])
@login_required
def admin_help():
    """Admin chatbot for helping users"""
    try:
        data = request.get_json()
        question = data.get('question', '').strip().lower()
        
        # Predefined responses for common questions
        responses = {
            'р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓': """ЁЯФз **р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕гр╕░р╕Ър╕Ъ:**
            
1. **р╣Др╕Ыр╕Чр╕╡р╣Ир╕лр╕Щр╣Йр╕▓ Settings** 
   - р╕Др╕ер╕┤р╕Б "Settings" р╣Гр╕Щр╣Ар╕бр╕Щр╕╣

2. **р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Google Sheets**
   - р╣Гр╕кр╣И Google Sheets ID
   - р╕нр╕▒р╕Юр╣Вр╕лр╕ер╕Ф Google Credentials JSON

3. **р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ AI**
   - р╕Ыр╕гр╕▒р╕Ъ System Prompt р╕Хр╕▓р╕бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
   - р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ AI API URL р╣Бр╕ер╕░ Model

4. **р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ**
   - р╣Гр╕кр╣И Line Token
   - р╣Гр╕кр╣И Telegram Bot Token

ЁЯТб **р╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕зр╕нр╕вр╣Ир╕▓р╕ер╕╖р╕бр╕Бр╕Ф "р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓"**""",
            
            'р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ': """ЁЯТм **р╕зр╕┤р╕Шр╕╡р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ AI Chat:**

1. **р╕Юр╕┤р╕бр╕Юр╣Мр╕Др╕│р╕Цр╕▓р╕б** - р╕Цр╕▓р╕бр╕нр╕░р╣Др╕гр╕Бр╣Зр╣Др╕Фр╣Йр╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Бр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ Google Sheets
2. **р╕гр╕нр╕Бр╕▓р╕гр╕Хр╕нр╕Ъ** - AI р╕Ир╕░р╕Др╣Йр╕Щр╕лр╕▓р╣Бр╕ер╕░р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╣Й
3. **р╕Фр╕╣р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М** - р╣Др╕Фр╣Йр╕Др╕│р╕Хр╕нр╕Ър╕Чр╕╡р╣Ир╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕гр╕┤р╕З

**р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Др╕│р╕Цр╕▓р╕б:**
- "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣Ир╕бр╕╡р╕нр╕░р╣Др╕гр╕Ър╣Йр╕▓р╕З"
- "р╕кр╕гр╕╕р╕Ыр╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й"
- "р╕гр╕▓р╕вр╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕бр╕╡р╕кр╕Хр╣Зр╕нр╕Бр╕Щр╣Йр╕нр╕в"

ЁЯОп **р╕вр╕┤р╣Ир╕Зр╕Цр╕▓р╕бр╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ р╕вр╕┤р╣Ир╕Зр╣Др╕Фр╣Йр╕Др╕│р╕Хр╕нр╕Ър╕Хр╕гр╕Зр╕Ир╕╕р╕Ф!**""",
            
            'р╕Ыр╕▒р╕Нр╕лр╕▓': """ЁЯЪи **р╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓р╕Юр╕Ър╕Ър╣Ир╕нр╕в:**

**р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕ер╣Зр╕нр╕Бр╕нр╕┤р╕Щр╣Др╕Фр╣Й:**
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ username/password р╣Гр╕Щ Google Sheets р╕Кр╕╡р╕Х1 cell A2:B2
- р╣Гр╕лр╣Йр╣Бр╕Щр╣Ир╣Гр╕Ир╕зр╣Ир╕▓ Google Sheets р╣Ар╕Ыр╕┤р╕Фр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕Фр╣Й

**AI р╕Хр╕нр╕Ър╣Др╕бр╣Ир╕Цр╕╣р╕Б:**
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Google Credentials
- р╕ер╕нр╕Зр╕гр╕╡р╣Ар╕Яр╕гр╕Кр╕Вр╣Йр╕нр╕бр╕╣р╕е
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ AI API URL

**р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕нр╕▒р╕Юр╣Ар╕Фр╕Ч:**
- р╕Бр╕Ф "р╕гр╕╡р╣Ар╕Яр╕гр╕Кр╕Вр╣Йр╕нр╕бр╕╣р╕е" р╣Гр╕Щр╕лр╕Щр╣Йр╕▓р╣Бр╕Кр╕Ч
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Google Sheets р╕бр╕╡р╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕З

тЭУ **р╕вр╕▒р╕Зр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓? р╕ер╕нр╕Зр╕Фр╕╣р╣Гр╕Щ Settings > р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н**""",
            
            'р╕Др╕│р╕Цр╕▓р╕бр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З': """ЁЯТб **р╕Др╕│р╕Цр╕▓р╕бр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Чр╕╡р╣Ир╕Фр╕╡:**

**р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕ер╕╣р╕Бр╕Др╣Йр╕▓:**
- "р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕▓р╕вр╕╕р╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 30 р╕Ыр╕╡р╕бр╕╡р╕Бр╕╡р╣Ир╕Др╕Щ"
- "р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Ир╕▓р╕Бр╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Фр╣Др╕лр╕Щр╕бр╕╡р╕бр╕▓р╕Бр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф"
- "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╕Вр╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Кр╕╖р╣Ир╕н..."

**р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕┤р╕Щр╕Др╣Йр╕▓:**
- "р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕лр╕бр╣Ир╕Чр╕╡р╣Ир╣Ар╕Юр╕┤р╣Ир╕Зр╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╕бр╕╡р╕нр╕░р╣Др╕гр╕Ър╣Йр╕▓р╕З"
- "р╕гр╕▓р╕Др╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓... р╣Ар╕Чр╣Ир╕▓р╣Др╕лр╕гр╣И"
- "р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕лр╕бр╕Фр╕кр╕Хр╣Зр╕нр╕Бр╕бр╕╡р╕нр╕░р╣Др╕г
